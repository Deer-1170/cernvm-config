#!/bin/sh

ROOT_PATH=$1

if [ "x$UCONTEXT_SRC" = "xEC2" ]; then
  grep MAAS ${ROOT_PATH}/etc/cloud/cloud.cfg.d/50_cernvm.cfg | sed -e 's/MAAS/MAAS, Ec2/' > ${ROOT_PATH}/etc/cloud/cloud.cfg.d/51_enable_ec2.cfg    
fi

if [ "x$UCONTEXT_SRC" = "xCloudStack" ]; then
  grep MAAS ${ROOT_PATH}/etc/cloud/cloud.cfg.d/50_cernvm.cfg | sed -e 's/MAAS/MAAS, CloudStack/' > ${ROOT_PATH}/etc/cloud/cloud.cfg.d/51_enable_cloudstack.cfg
fi

if [ "x$UCONTEXT_SRC" = "xGCE" ]; then
  mv ${ROOT_PATH}/etc/init/google-accounts-manager-task.conf.disabled ${ROOT_PATH}/etc/init/google-accounts-manager-task.conf
fi

SYSTEM_ID=$(cat $(ls -tr ${ROOT_PATH}/.installed_cernvm-system-* 2>/dev/null | tail -n1) /dev/null)
if [ "x$SYSTEM_ID" != "x" ]; then
  log_start "Booting"
  log_info "$SYSTEM_ID"
fi

